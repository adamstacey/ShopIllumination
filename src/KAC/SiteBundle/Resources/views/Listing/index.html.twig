{% extends 'KACSiteBundle::base.html.twig' %}

{% if department is not null and brand is null %}
    {% set title = department.description.pageTitle %}
{% elseif department is null and brand is not null %}
    {% set title = brand.description.pageTitle %}
{% elseif department is not null and brand is not null %}
    {% set title = department.description.pageTitle ~ ' | ' ~ brand.description.pageTitle %}
{% else %}
    {% set title = 'Products' %}
{% endif %}
{% block title %}{{ title }}{% endblock %}

{% block metatags %}
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta name="description" content="{{ department.metaDescription }}">
    <meta name="keywords" content="{{ department.metaKeywords }}">
    <meta name="fragment" content="!">
{% endblock %}

{% block header %}
    {% if department is not null and brand is null %}
        <h1 class="mtl mbn">{{ department.description.header }}</h1>
    {% elseif department is null and brand is not null %}
        <h1 class="mtl mbn">{{ brand.description.header }}</h1>
    {% elseif department is not null and brand is not null %}
        <h1 class="mtl mbn">{{ brand.description.header }} {{ department.description.header }}</h1>
    {% else %}
        <h1 class="mtl mbn">Products</h1>
    {% endif %}

    {% if app.request.query.get('q', '') is not empty %}
        <h2>Searching for "{{ app.request.query.get('q', '') }}"</h2>
    {% endif %}

    {% if department is not null and brand is null and brand.description.description%}
        <div class="department-description">
            {{ department.description.description|raw }}
        </div>
    {% elseif department is null and brand is not null and department.description.description %}
        <div class="department-description">
            {{ brand.description.description|raw }}
        </div>
    {% elseif department is not null and brand is not null and (brand.description.description or department.description.description) %}
        <div class="department-description">
            {% if brand.description.description %}
                {{ brand.description.description|raw }}
            {% endif %}
            {% if department.description.description %}
                {{ brand.description.description|raw }}
            {% endif %}
        </div>
    {% endif %}
{% endblock %}

{% block body %}
    <style>
        .product-sorting-container, .product-filtering-container {
            padding: 5px 0;

            background: -webkit-linear-gradient(top, white 0%, #c5d2d6 100%);

        }

        .product-sorting-container-top, .product-filtering-container {
            margin: -10px -10px 10px -10px;

            border-bottom: 2px solid #6c8087;
            border-radius: 4px 4px 0 0;
        }

        .product-sorting-container-bottom {
            margin: 10px -10px -10px -10px;

            border-top: 2px solid #6c8087;
            border-radius: 0 0 4px 4px;
        }

        .product-sorting-container > div > span, .product-filtering-container > div > span {
            padding: 0 5px 0 0;

            line-height: 40px;
            font-size: 11px;
        }

        .product-sorting-container .selector {
            margin: 0 5px 0 0;
        }

        .product-sorting-container .selector span {
            font-size: 11px;
        }

        .product-sorting-container .ui-button {
            padding: 3px 0;
            margin: 0 0 -4px -4px;
        }


        .product-sorting-container .ui-button span {
            padding: 0 8px;
        }

        .product-sorting-container .ui-button .ui-icon {
            padding: 0;
        }

        .filters .ui-widget header h2 {
            letter-spacing: 0px;
            font-size: 13px;
            font-family: "Lucida Grande", "Lucida Sans Unicode", "Helvetica Neue", Helvetica, Arial, Verdana, sans-serif;
        }

        .filter-header-buttons-container {
            top: 3px;
            right: 3px;

            position: absolute;
        }

        .filter-header-buttons-container .ui-button {
            padding: 0 2px;
        }

        .filter,
        .price-range-filter {
            padding: 0;

            background: #F3F6F6;
            border-radius: 0 0 4px 4px;
        }

        .price-range-filter {
            padding: 5px 15px;
        }

        .range-slider-values {
            text-align: center;
        }

        .range-slider-values input {
            width: 60px;
            text-align: center;
        }

        .price-range {
            margin: 5px 0 5px 0;
        }

        .price-range .ui-slider-range {
            padding: 0;
        }

        .filter ul li a.selected-filter {
            font-weight: bold;
            text-decoration: underline;
        }

        .filter label {
            line-height: 18px;
        }

        .filter ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .filter > ul {
            padding: 0 0 5px 0;
        }

        .filter ul li {
            list-style: none;
            margin: 0;
            display: block;
            padding: 2px 5px 2px 28px;
            background-colour: #F3F6F6;
            border-bottom: 1px solid #C5D2D6;
            color: #000;
            position: relative;
        }

        .jstree a {
            font-size: 11px;
            line-height: 18px;
        }

        .jstree li,
        .jstree ins {
            background-image:url("/bundles/kacsite/plugins/jstree/resources/images/jstree_d.png");
            background-repeat: no-repeat;
            background-color: transparent;
            background-size: 108px 18px;
        }

        .jstree li {
            background-position: -90px 0;
            background-repeat: repeat-y;
        }

        .jstree .jstree-open > ins {
            background-position: -36px 0;
        }

        .jstree .jstree-closed > ins {
            background-position: -18px 0;
        }

        .jstree .jstree-leaf > ins {
            background-position: 0 0;
        }

        .jstree .jstree-no-dots li {
            background-position: -108px 0;
        }

        .jstree .jstree-no-dots .jstree-open > ins {
            background-position: -72px 0;
        }

        .jstree .jstree-no-dots .jstree-closed > ins {
            background-position: -54px 0;
        }

        .jstree li,
        .jstree ins {
            _background-image: url("/bundles/kacsite/plugins/jstree/resources/images/jstree_d.gif");
        }

        .jstree .jstree-open ins {
            _background-position: -36px 0;
        }
        .jstree .jstree-closed ins {
            _background-position: -18px 0;
        }
        .jstree .jstree-leaf ins {
            _background-position: 0 0;
        }

        @media
        screen and (-webkit-min-device-pixel-ratio: 1.25),
        screen and (-webkit-min-device-pixel-ratio: 1.3),
        screen and (-webkit-min-device-pixel-ratio: 1.5),
        screen and (-webkit-min-device-pixel-ratio: 2),
        screen and (min--moz-device-pixel-ratio: 1.25),
        screen and (min--moz-device-pixel-ratio: 1.3),
        screen and (min--moz-device-pixel-ratio: 1.5),
        screen and (min--moz-device-pixel-ratio: 2),
        screen and (-o-min-device-pixel-ratio: 1.25/1),
        screen and (-o-min-device-pixel-ratio: 1.3/1),
        screen and (-o-min-device-pixel-ratio: 1.5/1),
        screen and (-o-min-device-pixel-ratio: 2/1),
        screen and (min-device-pixel-ratio: 1.25),
        screen and (min-device-pixel-ratio: 1.3),
        screen and (min-device-pixel-ratio: 1.5),
        screen and (min-device-pixel-ratio: 2),
        screen and (min-resolution: 120dpi),
        screen and (min-resolution: 124.8dpi),
        screen and (min-resolution: 144dpi),
        screen and (min-resolution: 192dpi),
        screen and (min-resolution: 1.25dppx),
        screen and (min-resolution: 1.3dppx),
        screen and (min-resolution: 1.5dppx),
        screen and (min-resolution: 2dppx) {
            .jstree li,
            .jstree ins {
                background-image:url("/bundles/kacsite/plugins/jstree/resources/images/jstree_d@2x.png");
            }


        .department-filter ul {
            padding: 0 0 0 18px;
        }

        .department-filter > ul {
            padding: 10px 5px;
        }

        .department-filter ul li {
            background-color: transparent;
            padding: 0;
            margin: 0;
            border: 0;
            width: 100%;
        }

        .department-filter > ul > li {
            margin: 0;
        }

        .department-filter ul li a {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: 0 none;
            display: block;
            text-decoration: none;
        }

        .department-filter ul li a:hover {
            text-decoration: underline;
        }

        .department-filter ul li ins {
            width: 18px;
            height: 18px;
            background-repeat: no-repeat;
            background-size: 108px 18px;
            overflow: hidden;
            cursor: pointer;
            float: left;
        }

        .filter ul li .checker {
            position: absolute;
            top: 2px;
            left: 5px;
        }

        .filter ul li.filter-sub-department {
            padding: 2px 5px 2px 60px!important;
        }

        .filter ul li.filter-sub-department .checker {
            left: 32px;
        }

        .filter ul li.filter-feature-group {
            padding: 5px 26px 5px 5px!important;
            border-bottom: 1px solid #C5D2D6!important;
            cursor: pointer;
            color: #143B49;
            position: relative;
            background: #f3f6f6; /* Old browsers */
            /* IE9 SVG, needs conditional override of 'filter' to 'none' */
            background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2YzZjZmNiIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNjNWQyZDYiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
            background: -moz-linear-gradient(top,  #f3f6f6 0%, #c5d2d6 100%); /* FF3.6+ */
            background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#f3f6f6), color-stop(100%,#c5d2d6)); /* Chrome,Safari4+ */
            background: -webkit-linear-gradient(top,  #f3f6f6 0%,#c5d2d6 100%); /* Chrome10+,Safari5.1+ */
            background: -o-linear-gradient(top,  #f3f6f6 0%,#c5d2d6 100%); /* Opera 11.10+ */
            background: -ms-linear-gradient(top,  #f3f6f6 0%,#c5d2d6 100%); /* IE10+ */
            background: linear-gradient(top,  #f3f6f6 0%,#c5d2d6 100%); /* W3C */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#f3f6f6', endColorstr='#c5d2d6',GradientType=0 ); /* IE6-8 */
        }

        .filter ul li.filter-feature-group .ui-icon {
            position: absolute;
            top: 4px;
            right: 5px;
        }

        .filter ul li label {
            font-size: 10px;
            cursor: pointer;
        }

        .filter ul li label a {
            color: #000;
            cursor: pointer;
        }

        .filter ul li.filter-sub-department label {
            font-size: 11px;
        }

        .filter ul li .checker {
            margin: 0 5px 0 0!important;
        }

        .filter ul li span.fr {
            line-height: 20px;
            font-size: 10px;
            display: block;
            width: 30px;
            text-align: right;
            color: #676767;
        }
    </style>
    <section class="clearfix">
        <div class="widget-group clearfix mbm">
            <div class="widget widget-7-of-8">
                <ul class="breadcrumbs" itemprop="breadcrumb">
                    <li>{{ department.description.header }}</li>
                    {% for parent in department.parents %}
                        {% if parent.parent != null and parent.level != 1  %}
                            <li><a href="{{ path('routing', {'url': parent.url}) }}">{{ parent.description.header }}</a></li>
                        {% endif %}
                    {% endfor %}
                    <li><a href="{{ path('homepage') }}">Kitchen Appliances</a></li>
                </ul>
            </div>
            <div class="widget widget-1-of-8">
                {% if is_granted('ROLE_ADMIN') and admin == false %}
                    {#<a href="{{ path('admin_'~app.request.get('_route'), (app.request.query.all?app.request.get('_route_params')|merge(app.request.query.all):app.request.get('_route_params'))) }}" class="fr button button-blue button-small">Admin Mode</a>#}
                {% endif %}
            </div>
        </div>
        {% if pagination.totalItemCount is defined %}
            {% set totalItemCount = pagination.totalItemCount %}
        {% else %}
            {% set totalItemCount = 0 %}
        {% endif %}
        <div class="widget-group clearfix">
            <form id="formFilter" class="form" method="GET">
                <div class="widget widget-5-of-7 listing">
                    <div class="ui-widget mbl">
                        <section class="ui-widget-content ui-corner-all">
                            <div class="widget-group product-sorting-container product-sorting-container-top clearfix">
                                <div class="widget widget-1-of-1">
                                    <span class="fl">Sort By</span>
                                    <div class="fl prs">
                                        <select id="sortOrderTop" name="sort_order" class="fill fl">
                                            <option{% if app.request.get('sort_order') == 'header_sort:asc' %} selected="selected"{% endif %} value="header_sort:asc">Alphabetically: A-Z</option>
                                            <option{% if app.request.get('sort_order') == 'header_sort:desc' %} selected="selected"{% endif %} value="header_sort:desc">Alphabetically: Z-A</option>
                                            <option{% if app.request.get('sort_order') == 'low_price:asc' or app.request.get('sort_order') is not defined or app.request.get('sort_order') is null %} selected="selected"{% endif %} value="low_price:asc">Price: Lowest First</option>
                                            <option{% if app.request.get('sort_order') == 'high_price:desc' %} selected="selected"{% endif %} value="high_price:desc">Price: Highest First</option>
                                            <option{% if app.request.get('sort_order') == 'created_at:desc' %} selected="selected"{% endif %} value="created_at:desc">Latest</option>
                                        </select>
                                    </div>
                                    <span class="fl">Show</span>
                                    <div class="fl prs">
                                        <select id="limitTop" name="limit" class="fill fl">
                                            <option{% if app.request.get('limit') == '10' %} selected="selected"{% endif %} value="10">10</option>
                                            <option{% if app.request.get('limit') == '20' or app.request.get('limit') is not defined or app.request.get('limit') is null %} selected="selected"{% endif %} value="20">20</option>
                                            <option{% if app.request.get('limit') == '50' %} selected="selected"{% endif %} value="50">50</option>
                                            <option{% if app.request.get('limit') == '100' %} selected="selected"{% endif %} value="100">100</option>
                                            <option{% if app.request.get('limit') == '99999999' %} selected="selected"{% endif %} value="99999999">All</option>
                                        </select>
                                    </div>
                                    <span class="fl">of <strong>{{ totalItemCount }}</strong> Product{{ totalItemCount == 1 ? '' : 's' }}</span>
                                    <div class="fr">
                                        {{ knp_pagination_render(pagination) }}
                                    </div>
                                </div>
                            </div>
                            <div id="products">
                                {% for product in pagination %}
                                    {% block product_block %}
                                        <div itemscope itemtype="http://schema.org/Product" class="product relative" data-product-id="{{ product.id }}" id="product-{{ product.id }}">
                                            <div class="fl">
                                                <img class="fl product-image" itemprop="image" src="{{ asset(product.thumbnail_path) }}" border="0" alt="{{ product.header|raw }}" width="150" />
                                            </div>
                                            <div>
                                                <div>
                                                    {% if product.brand_logo != '' %}
                                                        <a href="{{ path('routing', {'url': product.brand_logo}) }}">
                                                            <img class="fr brand-logo-image" src="{{ asset(product.brand_logo) }}" border="0" alt="{{ product.brand|raw }}" height="20" />
                                                        </a>
                                                    {% endif %}
                                                    <h4><a itemprop="name" href="{{ product.url != '' ? path('routing', {'url': product.url}) : '' }}">{{ product.header|raw }}</a></h4>

                                                    {% for feature in product.features %}
                                                        {% if 'COLOUR:' in feature|upper %}
                                                            {% spaceless %}
                                                                <p class="colour">
                                                                    {% if product.url != '' %}
                                                                        <a href="{{ path('routing', {'url': product.url}) }}">
                                                                    {% endif %}
                                                                    <strong>{{ featureGroup|upper|replace({'COLOUR:': ''}) }}</strong>
                                                                    {% if product.url != '' %}
                                                                        </a>
                                                                    {% endif %}
                                                                </p>
                                                            {% endspaceless %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>

                                                <div class="product-options">
                                                    <div itemprop="offers" itemscope itemtype="http://schema.org/Offer">
                                                        <p class="ar product-price">
                                                            {% spaceless %}
                                                                {% if product.hide_price == 0 %}
                                                                    {% if product.url != '' %}
                                                                        <a href="{{ path('routing', {'url': product.url}) }}">
                                                                    {% endif %}
                                                                    {% if product.low_price == product.high_price %}
                                                                        <span itemprop="price">&pound;{{ product.low_price|number_format(2) }}</span>
                                                                    {% else %}
                                                                        <span itemprop="price">&pound;{{ product.low_price|number_format(2) }}</span>
                                                                        <em> - </em>
                                                                        <span itemprop="price">&pound;{{ product.high_price|number_format(2) }}</span>
                                                                    {% endif %}
                                                                    {% if product.url != '' %}
                                                                        </a>
                                                                    {% endif %}
                                                                    <span class="product-tax"> (inc. VAT)</span>
                                                                {% else %}
                                                                    <a itemprop="price" href="{#{{ path('content_contact_us') }}#}">CONTACT US</a>
                                                                {% endif %}
                                                            {% endspaceless %}
                                                        </p>
                                                    </div>

                                                    {% if admin == true %}
                                                        <a href="{{ path('products_delete', {'productId': product.id}) }}" class="fr button button-red">Delete</a>
                                                        <a href="{{ path('products_edit', {'productId': product.id}) }}" class="fr button button-blue">Edit</a>
                                                    {% else %}
                                                        <a href="{{ product.url != '' ? path('routing', {'url': product.url}) : '' }}" class="fr button  button-green icon-white button-small">More Info</a>
                                                        <a href="{{ product.url != '' ? path('routing', {'url': product.url}) : '' }}#buynow" class="fr button button-blue button-small mrs">Buy Now</a>
                                                    {% endif %}
                                                </div>


                                                {% if product.features|length > 0 %}
                                                    <div class="product-information">
                                                        <ul>
                                                            {% for featureGroup in product.features|slice(1, 4) %}
                                                                {% set feature = product['attr_feature_'~featureGroup][0] %}
                                                                {% if feature != '' %}
                                                                    {% if feature == 'Yes' %}
                                                                        {% set className = 'green-tick' %}
                                                                    {% elseif feature == 'No' %}
                                                                        {% set className = 'red-cross' %}
                                                                    {% else %}
                                                                        {% set className = 'bullet' %}
                                                                    {% endif %}
                                                                    <li class="{{ className }}">{{ featureGroup }}: <strong>{{ feature }}</strong></li>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                {% endif %}

                                                {% if '|1034|1122|69|' in product.departmentIds %}
                                                    <div class="small-floating-offer small-floating-offer-top-left">
                                                        <p class="small-floating-offer-title">40% OFF</p>
                                                        <p class="small-floating-offer-description">Stellar<br />Pans</p>
                                                    </div>
                                                {% endif %}
                                                {% if product.brandId == '7' %}
                                                    <div class="medium-floating-offer medium-floating-offer-bottom-left">
                                                        <p class="medium-floating-offer-title">10% OFF</p>
                                                        <p class="medium-floating-offer-description">When you buy 3 or more CDA items</p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="clear"></div>
                                        </div>
                                    {% endblock %}
                                {% else %}
                                    <p class="no-products">Sorry, there are currently no products in this department.</p>
                                {% endfor %}
                                <div class="clear"></div>
                            </div>
                            <div class="widget-group product-sorting-container product-sorting-container-bottom clearfix">
                                <div class="widget widget-1-of-1">
                                    <span class="fl">Sort By</span>
                                    <div class="fl prs">
                                        <select id="sortOrderBottom" class="fill fl">
                                            <option{% if app.request.get('sort_order') == 'header_sort:asc' %} selected="selected"{% endif %} value="header_sort:asc">Alphabetically: A-Z</option>
                                            <option{% if app.request.get('sort_order') == 'header_sort:desc' %} selected="selected"{% endif %} value="header_sort:desc">Alphabetically: Z-A</option>
                                            <option{% if app.request.get('sort_order') == 'low_price:asc' or app.request.get('sort_order') is not defined or app.request.get('sort_order') is null %} selected="selected"{% endif %} value="low_price:asc">Price: Lowest First</option>
                                            <option{% if app.request.get('sort_order') == 'high_price:desc' %} selected="selected"{% endif %} value="high_price:desc">Price: Highest First</option>
                                            <option{% if app.request.get('sort_order') == 'created_at:desc' %} selected="selected"{% endif %} value="created_at:desc">Latest</option>
                                        </select>
                                    </div>
                                    <span class="fl">Show</span>
                                    <div class="fl prs">
                                        <select id="limitBottom" class="fill fl">
                                            <option{% if app.request.get('limit') == '10' %} selected="selected"{% endif %} value="10">10</option>
                                            <option{% if app.request.get('limit') == '20' or app.request.get('limit') is not defined or app.request.get('limit') is null %} selected="selected"{% endif %} value="20">20</option>
                                            <option{% if app.request.get('limit') == '50' %} selected="selected"{% endif %} value="50">50</option>
                                            <option{% if app.request.get('limit') == '100' %} selected="selected"{% endif %} value="100">100</option>
                                            <option{% if app.request.get('limit') == '99999999' %} selected="selected"{% endif %} value="99999999">All</option>
                                        </select>
                                    </div>
                                    <span class="fl">of <strong>{{ totalItemCount }}</strong> Product{{ totalItemCount == 1 ? '' : 's' }}</span>
                                    <div class="fr">
                                        {{ knp_pagination_render(pagination) }}
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>

                <div class="widget widget-2-of-7">
                    <div class="ui-widget mbn">
                        <section class="ui-widget-content ui-corner-all">
                            <div class="widget-group product-filtering-container clearfix">
                                <div class="widget widget-1-of-1">
                                    <span class="fl"><strong>Narrow Search By</strong></span>
                                    <a class="button button-grey icon-grey fr" data-icon-primary="icon-1113" href="{{ path('routing', {'url': department.url}) }}">Reset All</a>
                                </div>
                            </div>
                            <div class="filters">
                                <div class="ui-widget pr mtm">
                                    <header class="ui-widget-header ui-corner-top">
                                        <h2>Price</h2>
                                    </header>
                                    <section class="ui-widget-content pan ui-corner-bottom">
                                        <div id="filterPrice" class="price-range-filter">
                                            <div class="range-slider-values">
                                                <span>&pound;</span>
                                                <input type="text" name="filter[low_price]" id="filterLowPrice" value="{{ app.request.get('filter[low_price]', '%.0f'|format(stats.getResult('low_price').min|default(0)), true) }}" />
                                                <span>&nbsp;-&nbsp;</span>
                                                <input type="text" name="filter[high_price]" id="filterHighPrice" value="{{ app.request.get('filter[high_price]', '%.0f'|format(stats.getResult('high_price').max|default(9999)), true) }}" />
                                            </div>
                                            <div id="priceRangeSlider" class="price-range pan"></div>
                                        </div>
                                    </section>
                                    <div class="filter-header-buttons-container">
                                        <button type="button" data-filter="Price" class="fr button button-small button-grey icon-grey actionShowHideFilter" data-icon-primary="icon-467" data-icon-only="true">Hide</button>
                                        <button type="button" data-filter="Price" class="fr button button-small button-grey icon-grey actionResetFilter" data-icon-primary="icon-1113" data-icon-only="true">Reset</button>
                                    </div>
                                </div>

                                {{ render_esi(controller('KACSiteBundle:Listing:departmentTree', {'departmentId': department.id, 'brandId': brand.id})) }}

                                {% if brand is null %}
                                    <div class="ui-widget pr mtm">
                                        <header class="ui-widget-header ui-corner-top">
                                            <h2>Brand</h2>
                                        </header>
                                        <section class="ui-widget-content pan ui-corner-bottom">
                                            <div id="filterBrand" class="filter">
                                                <ul>
                                                    {% for brand, count in facets.facet('brands') %}
                                                        <li>
                                                            <input{% if brand in app.request.get('filter[brand]', null, true) %} checked="checked"{% endif %} name="filter[brand][]" type="checkbox" value="{{ brand }}" id="filter-brand-{{ loop.index }}" />
                                                            <label for="filter-brand-{{ loop.index }}"><span class="fr">({{ count }})</span>{{ brand }}</label>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </section>
                                        <div class="filter-header-buttons-container">
                                            <button type="button" data-filter="Brand" class="fr button button-small button-grey icon-grey actionShowHideFilter" data-icon-primary="icon-467" data-icon-only="true">Hide</button>
                                            <button type="button" data-filter="Brand" class="fr button button-small button-grey icon-grey actionResetFilter" data-icon-primary="icon-1113" data-icon-only="true">Reset</button>
                                        </div>
                                    </div>
                                {% endif %}
                                {% if featureGroups|length > 0 %}
                                    <div class="ui-widget pr mtm">
                                        <header class="ui-widget-header ui-corner-top">
                                            <h2>Features</h2>
                                        </header>
                                        <section class="ui-widget-content pan ui-corner-bottom">
                                            <div id="filterFeature" class="filter">
                                                <ul>
                                                    {% for featureGroup in featureGroups %}
                                                        {% if facets.facet('feature_'~featureGroup|replace({' ': ''})) is not null and facets.facet('feature_'~featureGroup|replace({' ': ''})).count > 0 %}
                                                            <li data-feature-group="{{ loop.index }}" class="filter-feature-group"><span class="ui-button-icon-primary ui-icon ui-icon-triangle-1-n"></span>{{ featureGroup }}</li>
                                                            {% for feature, count in facets.facet('feature_'~featureGroup|replace({' ': ''})) %}
                                                                <li>
                                                                    <input{% if feature in app.request.get('filter[attr_feature_'~featureGroup~']', null, true) %} checked="checked"{% endif %} name="filter[attr_feature_{{ featureGroup }}][]" type="checkbox" value="{{ feature }}" id="filter-{{ featureGroup }}-{{ loop.index }}" />
                                                                    <label for="filter-{{ loop.index }}"><span class="fr">({{ count }})</span>{{ feature }}</label>
                                                                </li>
                                                            {% endfor %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            <input type="hidden" name="filter-features" id="filter-features" value="{{ departmentListing.features }}" />
                                        </section>
                                        <div class="filter-header-buttons-container">
                                            <button type="button" data-filter="Feature" class="fr button button-small button-grey icon-grey actionShowHideFilter" data-icon-primary="icon-467" data-icon-only="true">Hide</button>
                                            <button type="button" data-filter="Feature" class="fr button button-small button-grey icon-grey actionResetFilter" data-icon-primary="icon-1113" data-icon-only="true">Reset</button>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </section>
                    </div>
                </div>
            </form>
        </div>
    </section>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	{% include 'KACShopBundle:Departments:indexScript.js.twig' with {'noAjax': noAjax, 'url': url, 'brand': brand, 'group': group, 'departmentListing': departmentListing, 'department': department, 'level': 1} %}

    <script type="text/javascript">
        $(document).ready(function() {
            var $treeView = $("#filterDepartment");
            $treeView.jstree({
                "core": {
                    "initially_open": ["root"]
                },
                "plugins": ["themes", "html_data"],
                "themes": {
                    "theme": "default",
                    "dots": true,
                    "icons": false
                }
            });

            $("#sortOrderBottom").live('change', function() {
                $("#sortOrderTop").val($("#sortOrderBottom").val());
                $.uniform.update("#sortOrderTop");
            });

            $("#limitBottom").live('change', function() {
                $("#limitTop").val($("#limitBottom").val());
                $.uniform.update("#limitTop");
            });

            $(":input", "#form-settings, #formFilter").live('change', function() {
                $(this).closest("form").submit();
            });

            $(".actionResetFilter").live("click", function() {
                // Check if the filter is a price
                if ($(this).data("filter") === "Price") {
                    var $priceRangeSlider = $("#priceRangeSlider");
                    var $filterLowPrice = $("#filterLowPrice");
                    var $filterHighPrice = $("#filterHighPrice");
                    $filterLowPrice.unbind("change");
                    $filterHighPrice.unbind("change");
                    $filterLowPrice.val($priceRangeSlider.slider("option", "min"));
                    $filterHighPrice.val($priceRangeSlider.slider("option", "max"));
                } else {
                    $(":input", "#filter"+$(this).data("filter"))
                        .not(":button, :submit, :reset, :hidden")
                        .val("")
                        .removeAttr("checked")
                        .removeAttr("selected");
                }
                $(this).closest("form").submit();
            });

            $(".actionShowHideFilter").live("click", function() {
                var $buttonIcon = $(this).find(".ui-icon");
                var $widget = $(this).closest(".filter-header-buttons-container").closest(".ui-widget");
                var $filterHeader = $widget.find("header");
                var $filter = $widget.find("section > div");
                if ($buttonIcon.hasClass("icon-467")) {
                    $filter.hide();
                    $buttonIcon.removeClass("icon-467");
                    $buttonIcon.addClass("icon-466");
                    $filterHeader.removeClass("ui-corner-top");
                    $filterHeader.addClass("ui-corner-all");
                } else {
                    $filter.show();
                    $buttonIcon.removeClass("icon-466");
                    $buttonIcon.addClass("icon-467");
                    $filterHeader.removeClass("ui-corner-all");
                    $filterHeader.addClass("ui-corner-top");
                }
            });

            $("#priceRangeSlider").slider({
                range: true,
                min: parseInt({{ stats.getResult('low_price').min|default(0) }}, 10),
                max: parseInt({{ stats.getResult('high_price').max|default(9999) }}, 10),
                values: [parseInt('{{ app.request.get('filter[low_price]', stats.getResult('low_price').min|default(0), true) }}', 10), parseInt('{{ app.request.get('filter[high_price]', stats.getResult('high_price').max|default(9999), true) }}', 10)],
                slide: function(event, ui) {
                    $("#filterLowPrice").val(ui.values[0]);
                    $("#filterHighPrice").val(ui.values[1]);
                },
                change: function(event, ui) {
                    $(this).closest("form").submit();
                }
            });
        });
    </script>
{% endblock %}