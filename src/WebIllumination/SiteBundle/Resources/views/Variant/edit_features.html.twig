{% extends 'WebIlluminationSiteBundle::base.html.twig' %}

{% block title %}Features | {{ variant.description.pageTitle }}{% endblock %}

{% block body %}
    <div class="widget-group clearfix">
        <div class="widget widget-2-of-7">
            {% include 'WebIlluminationSiteBundle:Variant:editLeftMenu.html.twig' %}
        </div>
        <div class="widget widget-5-of-7">
            <section>
                <form class="form" id="form-edit" method="post" action="{{ path(app.request.attributes.get('_route'), {'productId': variant.product.id, 'variantId': variant.id}) }}" {{ form_enctype(form) }}>
                    <div class="widget-group clearfix">
                        <div class="widget widget-1-of-1">
                            <div class="ui-widget">
                                <header class="ui-widget-header ui-corner-top">
                                    <span Features="ui-button-icon-primary ui-icon icon-white icon-276"></span>
                                    <h2>Features</h2>
                                </header>
                                <section class="ui-widget-content ui-corner-all">
                                    {% if form.errors %}
                                        <div class="message error">
                                            <p>You have <strong>{{ form.errors|length }}</strong> errors. Please fix the following errors before continuing:</p>
                                            {{ form_errors(form) }}
                                        </div>
                                    {% endif %}
                                    <fieldset class="pbm">
                                        <table class="form-table" id="feature-list" width="100%" data-prototype="{{ form_widget(form.features.vars.prototype) | e }}">
                                            <thead>
                                            <tr>
                                                <th>Group</th>
                                                <th>Feature</th>
                                                <th></th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% for row in form.features %}
                                                <tr>{{ form_widget(row) }}</tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                        {% do form.features.setRendered() %}
                                    </fieldset>
                                    {{ form_rest(form) }}


                                    <div class="clearfix">
                                        <button type="submit" class="button button-turquoise icon-white fr" data-icon-secondary="icon-471">Save</button>
                                        <button type="button" data-table-object="feature-list" class="actionAddFormRow mrm fr button button-green icon-white" data-icon-secondary="icon-1120">Add Feature</button>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                </form>
            </section>
        </div>
    </div>
    <script>
        jQuery(document).ready(function() {
            var count = {{ form.features | length }};

            jQuery(document).ready(function() {
                $(document).on("click", ".delete-row", function() {
                    $(this).parent().parent().remove();
                });
                jQuery('#add-feature').click(function() {
                    var list = jQuery("#feature-list");

                    var newItem = list.attr('data-prototype');
                    newItem = newItem.replace(/__name__/g, count);
                    count++;

                    var newRow = jQuery('<tr></tr>').html(newItem);
                    newRow.appendTo(list);
                    $('select', newRow).uniform();

                    return false;
                });
            });
            $(document).on('change', '.feature-group', function() {
                var groupId = $(this).val(),
                        that = this;
                $.getJSON('{{ path('api_features', {'featureGroupId': '-1'}) }}'.replace(/-1/, groupId), function(data) {
                    var select = $(that).parents("tr").find(".feature"),
                            options = [];
                    // Clear old features
                    select.val([]).empty();
                    // Add new features
                    for(var i=0; i<data.features.length; i++) {
                        var o = $('<option/>', { value: data.features[i]['id'] })
                                .text(data.features[i]['product_feature'])
                                .prop('selected', i == 0);
                        o.appendTo(select);
                    }
                    $.uniform.update(select);
                });
            });
        });
    </script>
{% endblock %}
